<div class="user-activity-report-container">
  <div class="page-header">
    <h1>{{ "admin.reports.user-activity.title" | translate }}</h1>
    <p class="text-muted">
      {{ "admin.reports.user-activity.description" | translate }}
    </p>
  </div>

  <!-- Error Alert -->
  <div
    *ngIf="error"
    class="alert alert-danger alert-dismissible fade show"
    role="alert"
  >
    <strong>{{ "error.general" | translate }}</strong> {{ error }}
    <button
      type="button"
      class="btn-close"
      (click)="error = null"
      aria-label="Close"
    ></button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="d-flex justify-content-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">{{ "loading" | translate }}</span>
    </div>
  </div>

  <!-- Report Content -->
  <div *ngIf="!loading && report" class="report-content">
    <!-- Summary Stats -->
    <div class="summary-stats mb-4">
      <div class="row">
        <div class="col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-label">
              {{ "admin.reports.user-activity.totalUsers" | translate }}
            </div>
            <div class="stat-value">{{ summary?.totalUsers || 0 }}</div>
          </div>
        </div>
        <div class="col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-label">
              {{ "admin.reports.user-activity.totalSubmissions" | translate }}
            </div>
            <div class="stat-value">{{ summary?.submissions || 0 }}</div>
          </div>
        </div>
        <div class="col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-label">
              {{ "admin.reports.user-activity.totalReviews" | translate }}
            </div>
            <div class="stat-value">{{ summary?.reviews || 0 }}</div>
          </div>
        </div>
        <div class="col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-label">
              {{ "admin.reports.user-activity.totalApprovals" | translate }}
            </div>
            <div class="stat-value">{{ summary?.approvals || 0 }}</div>
          </div>
        </div>
        <div class="col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-label">
              {{ "admin.reports.user-activity.totalRejections" | translate }}
            </div>
            <div class="stat-value">{{ summary?.rejections || 0 }}</div>
          </div>
        </div>
        <div class="col-md-4 col-lg-2">
          <div class="stat-card">
            <div class="stat-label">
              {{ "admin.reports.user-activity.totalWithdrawals" | translate }}
            </div>
            <div class="stat-value">{{ summary?.withdrawals || 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'summary'"
          (click)="setTab('summary')"
          type="button"
        >
          {{ "admin.reports.user-activity.summary" | translate }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'users'"
          (click)="setTab('users')"
          type="button"
        >
          {{ "admin.reports.user-activity.userStats" | translate }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'actions'"
          (click)="setTab('actions')"
          type="button"
        >
          {{ "admin.reports.user-activity.actions" | translate }}
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Summary Tab -->
      <div *ngIf="activeTab === 'summary'" class="tab-pane active">
        <div class="summary-tab">
          <h4>
            {{ "admin.reports.user-activity.reportSummary" | translate }}
          </h4>
          <div class="row mt-3">
            <div class="col-md-12">
              <div class="summary-info">
                <p>
                  <strong
                    >{{
                      "admin.reports.user-activity.totalUsers" | translate
                    }}:</strong
                  >
                  {{ summary?.totalUsers || 0 }}
                </p>
                <p>
                  <strong
                    >{{
                      "admin.reports.user-activity.totalSubmissions"
                        | translate
                    }}:</strong
                  >
                  {{ summary?.submissions || 0 }}
                </p>
                <p>
                  <strong
                    >{{
                      "admin.reports.user-activity.totalReviews" | translate
                    }}:</strong
                  >
                  {{ summary?.reviews || 0 }}
                </p>
                <p>
                  <strong
                    >{{
                      "admin.reports.user-activity.totalApprovals" | translate
                    }}:</strong
                  >
                  {{ summary?.approvals || 0 }}
                </p>
                <p>
                  <strong
                    >{{
                      "admin.reports.user-activity.totalRejections" | translate
                    }}:</strong
                  >
                  {{ summary?.rejections || 0 }}
                </p>
                <p>
                  <strong
                    >{{
                      "admin.reports.user-activity.totalWithdrawals"
                        | translate
                    }}:</strong
                  >
                  {{ summary?.withdrawals || 0 }}
                </p>
              </div>
            </div>
            <div class="col-md-12">
              <button class="btn btn-primary" (click)="downloadCSV()">
                <i class="bi bi-download"></i>
                {{ "admin.reports.user-activity.downloadCSV" | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div *ngIf="activeTab === 'users'" class="tab-pane active">
        <div class="users-tab">
          <h4>
            {{ "admin.reports.user-activity.userStatistics" | translate }}
          </h4>

          <!-- Search Box -->
          <div class="mb-3">
            <input
              type="text"
              class="form-control"
              placeholder="{{
                'admin.reports.user-activity.searchByEmailOrName' | translate
              }}"
              [(ngModel)]="searchEmail"
            />
          </div>

          <!-- Users Table -->
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-header-bg">
                <tr>
                  <th>
                    <a
                      href="javascript:void(0)"
                      (click)="toggleSort('name')"
                      class="sort-link"
                    >
                      {{ "admin.reports.user-activity.name" | translate }}
                      <span *ngIf="sortField === 'name'" class="sort-icon">
                        {{ sortDirection === "asc" ? "▲" : "▼" }}
                      </span>
                    </a>
                  </th>
                  <th>
                    {{ "admin.reports.user-activity.email" | translate }}
                  </th>
                  <th>
                    <a
                      href="javascript:void(0)"
                      (click)="toggleSort('submissions')"
                      class="sort-link"
                    >
                      {{
                        "admin.reports.user-activity.submissions" | translate
                      }}
                      <span
                        *ngIf="sortField === 'submissions'"
                        class="sort-icon"
                      >
                        {{ sortDirection === "asc" ? "▲" : "▼" }}
                      </span>
                    </a>
                  </th>
                  <th>
                    <a
                      href="javascript:void(0)"
                      (click)="toggleSort('reviews')"
                      class="sort-link"
                    >
                      {{ "admin.reports.user-activity.reviews" | translate }}
                      <span *ngIf="sortField === 'reviews'" class="sort-icon">
                        {{ sortDirection === "asc" ? "▲" : "▼" }}
                      </span>
                    </a>
                  </th>
                  <th>
                    <a
                      href="javascript:void(0)"
                      (click)="toggleSort('approvals')"
                      class="sort-link"
                    >
                      {{ "admin.reports.user-activity.approvals" | translate }}
                      <span *ngIf="sortField === 'approvals'" class="sort-icon">
                        {{ sortDirection === "asc" ? "▲" : "▼" }}
                      </span>
                    </a>
                  </th>
                  <th>
                    <a
                      href="javascript:void(0)"
                      (click)="toggleSort('rejections')"
                      class="sort-link"
                    >
                      {{ "admin.reports.user-activity.rejections" | translate }}
                      <span
                        *ngIf="sortField === 'rejections'"
                        class="sort-icon"
                      >
                        {{ sortDirection === "asc" ? "▲" : "▼" }}
                      </span>
                    </a>
                  </th>
                  <th>
                    <a
                      href="javascript:void(0)"
                      (click)="toggleSort('withdrawals')"
                      class="sort-link"
                    >
                      {{
                        "admin.reports.user-activity.withdrawals" | translate
                      }}
                      <span
                        *ngIf="sortField === 'withdrawals'"
                        class="sort-icon"
                      >
                        {{ sortDirection === "asc" ? "▲" : "▼" }}
                      </span>
                    </a>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of getFilteredUsers()">
                  <td>{{ user.userName }}</td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="badge bg-primary">{{
                      user.totalSubmissions
                    }}</span>
                  </td>
                  <td>
                    <span class="badge bg-info">{{
                      user.totalApprovals +
                        user.totalRejections +
                        user.totalWithdrawals
                    }}</span>
                  </td>
                  <td>
                    <span class="badge bg-success">{{
                      user.totalApprovals
                    }}</span>
                  </td>
                  <td>
                    <span class="badge bg-danger">{{
                      user.totalRejections
                    }}</span>
                  </td>
                  <td>
                    <span class="badge bg-warning text-dark">{{
                      user.totalWithdrawals
                    }}</span>
                  </td>
                </tr>
                <tr *ngIf="getFilteredUsers().length === 0">
                  <td colspan="7" class="text-center text-muted">
                    {{ "admin.reports.user-activity.noResults" | translate }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Actions Tab -->
      <div *ngIf="activeTab === 'actions'" class="tab-pane active">
        <div class="actions-tab">
          <h4>
            {{ "admin.reports.user-activity.allActions" | translate }}
          </h4>

          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead class="table-header-bg">
                <tr>
                  <th>
                    {{ "admin.reports.user-activity.action" | translate }}
                  </th>
                  <th>
                    {{ "admin.reports.user-activity.user" | translate }}
                  </th>
                  <th>
                    {{ "admin.reports.user-activity.email" | translate }}
                  </th>
                  <th>
                    {{ "admin.reports.user-activity.date" | translate }}
                  </th>
                  <th>
                    {{ "admin.reports.user-activity.details" | translate }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <ng-container
                  *ngFor="let user of report?.userStats; let i = index"
                >
                  <tr *ngFor="let action of user.actions">
                    <td>
                      <span
                        *ngIf="action.actionType === 'SUBMITTED'"
                        class="badge bg-primary"
                      >
                        {{
                          "admin.reports.user-activity.submitted" | translate
                        }}
                      </span>
                      <span
                        *ngIf="action.actionType === 'REVIEWED'"
                        class="badge bg-info"
                      >
                        {{ "admin.reports.user-activity.reviewed" | translate }}
                      </span>
                      <span
                        *ngIf="action.actionType === 'APPROVED'"
                        class="badge bg-success"
                      >
                        {{ "admin.reports.user-activity.approved" | translate }}
                      </span>
                      <span
                        *ngIf="action.actionType === 'REJECTED'"
                        class="badge bg-danger"
                      >
                        {{ "admin.reports.user-activity.rejected" | translate }}
                      </span>
                      <span
                        *ngIf="action.actionType === 'WITHDRAWN'"
                        class="badge bg-warning text-dark"
                      >
                        {{
                          "admin.reports.user-activity.withdrawn" | translate
                        }}
                      </span>
                    </td>
                    <td>{{ action.userName }}</td>
                    <td>{{ action.email }}</td>
                    <td>{{ action.actionDate | date: "short" }}</td>
                    <td>{{ action.details }}</td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
